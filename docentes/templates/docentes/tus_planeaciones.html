{% extends 'base_html.html' %}
{% load static%}

{% block head %}
    <link rel="stylesheet" href="{% static 'docentes/css/style.css' %}">  
{% endblock %}

{% block title %} LAPSOFT Mis planeaciones {% endblock %}
{% block body %}


    
    <h1 class="text-center">Tus Planeaci贸nes</h1>    


    <div id="contenedor-planeaciones-no-terminadas" class="plan-favoritos-container">
    </div><!-- Fin del contenedor de la plaeacion-->

    

    <h1 class="text-center">Tus planeaci贸nes terminadas</h1>   


    <!-- Contenedor de planeaciones no realizadas-->
    <div id="contenedor-planeaciones-si-terminadas" class="plan-favoritos-container">
    </div>
    <!-- Fin Contenedor de planeaciones no realizadas-->


    


<script>
    var likeOff = '{% static 'icons/iconLike.svg' %}';
    var likeOn = '{% static 'icons/iconLikeOn.svg' %}';
    var urlObtenerPlaneacionesUsuario ='{% url 'api:obtenerPlaneacionUsuario' %}';
    var urlObtenerActividades = '{% url 'api:obtenerActividades' 1 %}'.replace('1','');
    var urlBorrarActividad = '{% url 'api:borrarActividad' 1 %}'.replace('1','');
    var urlActualizarActividad = '{% url 'api:actualizarActividad' 1 %}'.replace('1','');
    var urlAgregarActividad = '{% url 'api:agregarActividad' 1 %}'.replace('1','');
    var urlActualizarPlaneacion = '{% url 'api:actualizarPlaneacion' 1 %}'.replace('1','');
    var urlBorrarPlaneacion = '{% url 'api:borrarPlaneacion' 1 %}'.replace('1','');


    

    let dias = ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado","Domingo"];

    /** para mostrar un modal en la pantalla (texto= texto a mostrar duracion=duracion del modal en milisegundos)
    */
    function mostrarModalMensaje(texto,duracion){
        var b = document.getElementById('body');
        b.innerHTML+=`
        <div id="info-modal" class="plan-calification">
        <img src="{% static 'icons/iconClose.svg' %}" alt="icono de cerrar ventana" onclick="cerrarModal()">
        <h3>${texto}</h3>
        </div>`;
        setTimeout(function(){document.getElementById('info-modal').remove();},duracion);
    }

    function desplegarPlan(id,slide){
        var pl = document.getElementById('plan-info-'+id);
        pl.classList.toggle('display-flex');
        slide.classList.toggle('rotar');

    }
    function desplegarTuPlan(id,slide){
        var pl = document.getElementById('plan-info-'+id);
        var btn = document.getElementById('plan-button-save-'+id);
        var planx = document.getElementById('plan-'+id);
        pl.classList.toggle('display-flex');
        btn.classList.toggle('display-flex');
        planx.classList.toggle('border-bottom');
        pl.classList.toggle('border-bottom');
        slide.classList.toggle('rotar');

        
        var contAct = document.getElementById('container-activities-'+id);
        if(contAct.innerHTML.trim() == ''){
            //console.log('siii')
            fetch(urlObtenerActividades+id,{
                headers:{
                    'Content-Type': 'application/json',
                    'Authorization':localStorage.getItem('token'),
                  }
            }).then(response=>{
                if(response.ok){
                    response.json().then(lista=>{
                        
                        
                        for(a in lista){
                            var f1= new Date(lista[a].fecha_de_inicio);

                            
                            contAct.innerHTML+=`
                            <div id="container-activitie-${lista[a].id}" class="container-activitie">
                                <div class="head-activities">
                                    <h3 id="info-act-titulo-principal-${lista[a].id}">${lista[a].titulo} ${dias[f1.getDay()]}</h3>
                                    <img title="Borrar actividad" class="iconStar" src="{% static 'icons/iconDelete.svg' %}" alt="icono de slide" onclick="borrarActividad(${lista[a].id},this)">
                                    <img title="Desplegar actividad" class="iconStar" src="{% static 'icons/iconSlide.svg' %}" alt="icono de slide" onclick="desplegarActividad(${lista[a].id},this)">
                                    <input id="info-act-check-${lista[a].id}" class="check-box" type="checkbox" ${lista[a].finalizada==true?'checked':'unchecked'}>
                
                                </div>
                                <div id="info-actividad-${lista[a].id}" class="body-activities">
                                        <h3>Fecha inicio</h3>
                                        <input type="date" name="" id="info-act-date-${lista[a].id}" value="${f1.toISOString().split('T')[0]}">
                                        <h3>Titulo</h3>
                                        <input type="text" name="" id="info-act-titulo-${lista[a].id}" placeholder="Titulo" value="${lista[a].titulo}">
                                        <h3>Descripci贸n</h3>
                                        <input type="text" name="" id="info-act-descripcion-${lista[a].id}" placeholder="Descripci贸n" value="${lista[a].descripcion}">
                                        <input class="button-succes margin-top" type="button" name="" value="Guardar actividad" id="" onclick="actualizarActividad(${lista[a].id})">
                                        
                                </div>
                                
                            </div>`;
                        }
                    }).catch(console.error())
                }
            });
        }else{
            //console.log('esta lleno')
        }

    }
    


    function desplegarActividad(id,slide){
        var pl = document.getElementById('info-actividad-'+id);
        pl.classList.toggle('display-flex');
        slide.classList.toggle('rotar');
    }
    function desplegarAgregarActividad(id,slide){
        var pl = document.getElementById('info-add-actividad-'+id);
        pl.classList.toggle('display-flex');
       
    }
    function desplegarComentarios(id,slide){
        var pl = document.getElementById('info-coment-'+id);
        pl.classList.toggle('display-flex');

        var pl1 = document.getElementById('plan-coment-close-'+id);
        pl1.classList.toggle('display-flex');

    }
    function cerrarComentarios(id,x){
        var pl = document.getElementById('info-coment-'+id);
        pl.classList.toggle('display-flex');
        x.classList.toggle('display-flex');
    }
    function darLike(id,li){
        if(li.src.includes(likeOff)){// si el src de la imagen contiene el likeOff entonces lo invertimos
            li.src = likeOn;
        }else{
            li.src = likeOff;
        }
    }
    function calificarPlaneacion(puntaje){
        var pc = document.getElementById('plan-calification-star');
        pc.innerHTML='';
        for(var a = 1; a <= puntaje;a++){//agregamos las estrellas amarillas
            pc.innerHTML+='<img src="{% static 'icons/iconStar.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion('+a+')" >';
        }
        for(a ; a <= 5;a++){//agregamos la estrellas grises
            pc.innerHTML+='<img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion('+a+')" >';
        }
        var modal = document.getElementById('plan-calificar-modal');
        setTimeout(function(){modal.remove();},790);
    }
    function cerrarModalCalificacion(){
        var modal = document.getElementById('plan-calificar-modal');
        modal.remove();
    }
    function mostrarModalCalificacion(){
        var b = document.getElementById('body');
        b.innerHTML+=`
        <div id="plan-calificar-modal" class="plan-calification">
        <img src="{% static 'icons/iconClose.svg' %}" alt="icono de cerrar ventana" onclick="cerrarModalCalificacion()">
        <h3>Calificame</h3>
        <div id="plan-calification-star" >
            <img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion(1)">
            <img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion(2)">
            <img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion(3)">
            <img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion(4)">
            <img src="{% static 'icons/iconStarOff.svg' %}" alt="icono de estrella" onclick="calificarPlaneacion(5)">
        </div>
        </div>`;
    }

    //------------------------------------------------------------------------------------- Para obtener las planeaciones
    async function obtenerPlaneacionUsuario(){
        var planSi = document.getElementById('contenedor-planeaciones-si-terminadas');
        var planNo = document.getElementById('contenedor-planeaciones-no-terminadas');
        fetch(urlObtenerPlaneacionesUsuario,{
            headers:{
                'Content-Type': 'application/json',
                'Authorization':localStorage.getItem('token'),
              }
        }).then(response=>{
            if(response.ok){
                response.json().then(lista=>{
                    var direccion;
                    for( a in lista){
                        if(lista[a].finalizada == true){// para mandar las planeaciones a los contenedores segun su estado (finalizada - no finalizada)
                            direccion = planSi;
                        }else{
                            direccion = planNo;
                        }
                        var f1= new Date(lista[a].fecha_de_inicio);
                        var f2= new Date(lista[a].fecha_de_finalizacion);
                        direccion.innerHTML+=`
                        <!--  planeacion-->
    <div id="contenedor-plan-${lista[a].id}" class="plan-container position-relative margin-1">

        
        
        <div id='plan-${lista[a].id}' class="plan">
            <div class="display-colum">
                <h2>${lista[a].titulo}</h2>
                <h3>${f1.getDate()+'/'+f1.getMonth()+'/'+f1.getFullYear()} a ${f2.getDate()+'/'+f2.getMonth()+'/'+f2.getFullYear()}</h3>
            </div>
            <div>
                <div class="plan-star">
                    <img title="Borrar planeaci贸n" class="iconStar" src="{% static 'icons/iconDelete.svg' %}" alt="icono estrella" onclick="borrarPlaneacion(${lista[a].id},this)">
                </div>
                <img title="Desplegar plan" class="iconStar" src="{% static 'icons/iconSlide.svg' %}" alt="icono de slide" onclick="desplegarTuPlan(${lista[a].id},this)">
                <input id="plan-check-${lista[a].id}" class="check-box" type="checkbox" ${lista[a].finalizada==true?'checked':'unchecked'}>
            </div>
        </div>
        <div id="plan-info-${lista[a].id}" class="plan-info border-bottom">
            <h3>Tema</h3>
            <input type="text" name="" id="plan-tema-${lista[a].id}" placeholder="Tema" value="${lista[a].tema}">
            <h3>Grado</h3>
            <input type="number" name="" id="plan-grado-${lista[a].id}" placeholder="Grado" value="${lista[a].grado}">
            <h3>Fecha inicio</h3>
            <input type="date" name="" id="plan-fecha-inicio-${lista[a].id}" value="${f1.toISOString().split('T')[0]}">
            <h3>Fecha finalizaci贸n</h3>
            <input type="date" name="" id="plan-fecha-fin-${lista[a].id}" value="${f2.toISOString().split('T')[0]}">
            <h2>Actividades</h2>

             <!--Agregar actividad-->
             <div class="container-add-activitie">

                <div class="container-activitie">
                    <div class="head-activities">
                        <h3>Agregar actividad</h3>
                        <img id='boton-agregar-actividad-${lista[a].id}' class="iconStar" src="{% static 'icons/iconAdd.svg' %}" alt="icono de slide" onclick="desplegarAgregarActividad(${lista[a].id},this)">
    
                    </div>
                    <div id="info-add-actividad-${lista[a].id}" class="body-activities">
                        
                            <h3>Fecha inicio</h3>
                            <input type="date" name="" id="info-add-date-${lista[a].id}">
                            <h3>Titulo</h3>
                            <input type="text" name="" id="info-add-titulo-${lista[a].id}" placeholder="Titulo">
                            <h3>Descripci贸n</h3>
                            <input type="text" name="" id="info-add-descripcion-${lista[a].id}" placeholder="Descripci贸n">
                            <input class="button-succes margin-top" type="button" name="" id="" value="Guardar actividad" onclick="agregarActividad(${lista[a].id})">
                    </div>
            
                </div>

            </div>

            <!-- Actividad-->
            <div id="container-activities-${lista[a].id}" class="container-activities"></div>

            <div class="plan-anonimo">
                <h3>Planeaci贸n anonima</h3>
                <input id="plan-anonima-${lista[a].id}" type="checkbox" ${lista[a].anonima==true?'checked':'unchecked'}>
            </div>

            <h2>Observaciones</h2>
            <input id="plan-observaciones-${lista[a].id}" type="text" placeholder="Observaciones" value="${lista[a].observaciones==null?'':lista[a].observaciones}">

            <div class="plan-anonimo">
                <h3>Finalizaci贸n</h3>
                <input id="plan-finalizacion-${lista[a].id}" type="checkbox" ${lista[a].finalizada==true?'checked':'unchecked'}>
            </div>

        </div>

        <button id="plan-button-save-${lista[a].id}" class="plan-coment button-bottom-succes display-none" onclick="actualizarPlaneacion(${lista[a].id})">Guardar</button>


        </div>
    <!-- Fin de planeacion-->
                        `;
                    }
                }).catch(console.error());
            }
        });
    }

    obtenerPlaneacionUsuario();
    async function actualizarPlaneacion(id){
        
        var tema = document.getElementById('plan-tema-'+id).value;
        var grado = document.getElementById('plan-grado-'+id).value;
        var fechaInicio = document.getElementById('plan-fecha-inicio-'+id).value;
        var fechaFin = document.getElementById('plan-fecha-fin-'+id).value;
        var anonima = document.getElementById('plan-anonima-'+id).checked;
        var observaciones = document.getElementById('plan-observaciones-'+id).value;
        var finalizacion = document.getElementById('plan-finalizacion-'+id).checked;   

        fetch(urlActualizarPlaneacion+id+','+tema+','+grado+','+fechaInicio+','+fechaFin+','+anonima+','+observaciones+','+finalizacion,{
            headers:{
                'Content-Type': 'application/json',
                'Authorization':localStorage.getItem('token'),
              }
        }).then(response =>{
            if(response.ok){// si la respuesta fue ok entonces se borro correctamente
                document.getElementById('plan-check-'+id).checked = finalizacion;// es el check de la parte superior cambie por el valor de la parte inferior
                
                alert('guardado correctamente');
            }else{
                mostrarModalMensaje('Error al actualizar',600);
            }
        }).catch(console.error());

    }

    function borrarActividad(id,element){
        fetch(urlBorrarActividad+id,{
            headers:{
                'Content-Type': 'application/json',
                'Authorization':localStorage.getItem('token'),
              }
        }).then(response=>{
            if(response.ok){// si la respuesta fue ok entonces se borro correctamente
                var actividad = document.getElementById('container-activitie-'+id);
                actividad.remove();
                mostrarModalMensaje('Registro eliminado con exito',650);
            }else{
                mostrarModalMensaje('Error al eliminar',650);
            }
        });
    }

    async function actualizarActividad(id){
        
        var date2 = document.getElementById('info-act-date-'+id).value;
        var titulo2 = document.getElementById('info-act-titulo-'+id).value;
        var desc2 = document.getElementById('info-act-descripcion-'+id).value;
        var ch = document.getElementById('info-act-check-'+id).checked;
        var exito = false;

        fetch(urlActualizarActividad+id+','+date2+','+titulo2+','+desc2+','+ch.toString(),{
            headers:{
                'Content-Type': 'application/json',
                'Authorization':localStorage.getItem('token'),
              }
        }).then(response =>{
            if(response.ok){// si la respuesta fue ok entonces se borro correctamente
                var tituloPrincipal = document.getElementById('info-act-titulo-principal-'+id);
                var f1= new Date(date2);
                tituloPrincipal.innerHTML=titulo2+' '+dias[f1.getDay()];
            
                //mostrarModalMensaje('Actualizada correctamente',800);
            }else{
                mostrarModalMensaje('Error al actualizar',600);
            }
        }).catch(console.error());

    }
    function agregarActividad(id_plan){
        
        var date1 = document.getElementById('info-add-date-'+id_plan).value;
        var titulo1 = document.getElementById('info-add-titulo-'+id_plan).value;
        var desc1 = document.getElementById('info-add-descripcion-'+id_plan).value;
        fetch(urlAgregarActividad+id_plan+','+date1+','+titulo1+','+desc1,{
            headers:{
                'Content-Type': 'application/json',
                'Authorization':localStorage.getItem('token'),
              }
        }).then(response =>{
            mostrarModalMensaje('Actividad agregada con exito',850);
            var btnOK = document.getElementById('boton-agregar-actividad-'+id_plan);
            btnOK.click()
            if(response.ok){// si la respuesta fue ok entonces se borro correctamente
                response.json().then(lista =>{
    
                var contenedorActividades = document.getElementById('container-activities-'+lista[0].id_planeacion);//contenedor de las actividades
                var f1= new Date(date1);
                //tituloPrincipal.innerHTML=titulo1+' '+dias[f1.getDay()];
                contenedorActividades.innerHTML+=`
                <div id="container-activitie-${lista[0].id}" class="container-activitie">
                    <div class="head-activities">
                        <h3 id="info-act-titulo-principal-${lista[0].id}">${lista[0].titulo} ${dias[f1.getDay()]}</h3>
                        <img title="Borrar actividad" class="iconStar" src="{% static 'icons/iconDelete.svg' %}" alt="icono de slide" onclick="borrarActividad(${lista[0].id},this)">
                        <img title="Desplegar actividad" class="iconStar" src="{% static 'icons/iconSlide.svg' %}" alt="icono de slide" onclick="desplegarActividad(${lista[0].id},this)">
                        <input class="check-box" type="checkbox" ${lista[0].finalizada==true?'checked':'unchecked'}>
    
                    </div>
                    <div id="info-actividad-${lista[0].id}" class="body-activities">
                            <h3>Fecha inicio</h3>
                            <input type="date" name="" id="info-act-date-${lista[0].id}" value="${f1.toISOString().split('T')[0]}">
                            <h3>Titulo</h3>
                            <input type="text" name="" id="info-act-titulo-${lista[0].id}" placeholder="Titulo" value="${lista[0].titulo}">
                            <h3>Descripci贸n</h3>
                            <input type="text" name="" id="info-act-descripcion-${lista[0].id}" placeholder="Descripci贸n" value="${lista[0].descripcion}">
                            <input class="button-succes margin-top" type="button" name="" id="" value="Guardar actividad" onclick="actualizarActividad(${lista[0].id})">
                    </div>
                    
                </div>`;

                }).catch(console.error());
                
            }else{
                mostrarModalMensaje('Error al guardar',850);
            }
        });
    }

    function borrarPlaneacion(id,element){
        fetch(urlBorrarPlaneacion+id).then(response=>{
            if(response.ok){// si la respuesta fue ok entonces se borro correctamente
                var actividad = document.getElementById('contenedor-plan-'+id);
                actividad.remove();
                mostrarModalMensaje('Registro eliminado con exito',650);
            }else{
                mostrarModalMensaje('Error al eliminar',650);
            }
        });
    }
    
    function borrarModal(){
        document.getElementById('cerrarModal').remove();
    }
</script>


{% endblock %}